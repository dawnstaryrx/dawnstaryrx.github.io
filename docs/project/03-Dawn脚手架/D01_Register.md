---
sidebar_position: 1
---

# æ³¨å†Œ

## ä¸€ã€éªŒè¯ç 

### 1. è¡Œä¸ºéªŒè¯ç 

#### 1.1 å·¥ä½œåŸç†

> â€œäººç±»åœ¨æ‰§è¡Œäº¤äº’æ“ä½œï¼ˆæ»‘åŠ¨ã€æ‹–åŠ¨ã€ç‚¹å‡»ç­‰ï¼‰æ—¶ï¼Œä¼šäº§ç”Ÿå…·æœ‰ç‰¹å¾çš„è¡Œä¸ºè½¨è¿¹ï¼Œè€Œæœºå™¨äººç¨‹åºå¾ˆéš¾å®Œç¾æ¨¡æ‹Ÿè¿™ç§è‡ªç„¶è¡Œä¸ºã€‚â€

ä¸»è¦æµç¨‹ï¼š

1. **å‰ç«¯å±•ç¤ºäº¤äº’ä»»åŠ¡**ï¼š
    æ¯”å¦‚æ»‘å—æ‹¼å›¾ã€æ—‹è½¬å›¾ç‰‡ã€æ‹–åŠ¨æ»‘æ¡åˆ°æŒ‡å®šä½ç½®ã€ç‚¹å‡»æ­£ç¡®é¡ºåºçš„å›¾æ ‡ç­‰ã€‚
2. **ç”¨æˆ·è¿›è¡Œæ“ä½œ**ï¼š
    ç³»ç»Ÿä¼šè®°å½•ç”¨æˆ·è¡Œä¸ºçš„è½¨è¿¹ï¼ˆå¦‚é¼ æ ‡ç§»åŠ¨è·¯å¾„ã€åŠ é€Ÿåº¦ã€æ—¶é—´é—´éš”ç­‰ï¼‰ã€‚
3. **åç«¯éªŒè¯è¡Œä¸ºç‰¹å¾**ï¼š
    é€šè¿‡ç®—æ³•åˆ¤æ–­è¯¥è¡Œä¸ºè½¨è¿¹æ˜¯å¦ç¬¦åˆâ€œäººç±»è‡ªç„¶æ“ä½œç‰¹å¾â€ï¼Œä»¥åŠæœ€ç»ˆç»“æœæ˜¯å¦æ­£ç¡®ã€‚
4. **è¿”å›éªŒè¯ç»“æœ**ï¼š
    æˆåŠŸåç”Ÿæˆä¸€ä¸ªéªŒè¯é€šè¿‡çš„ tokenï¼Œç”¨äºåç»­çš„æ•æ„Ÿæ“ä½œï¼ˆå¦‚ç™»å½•ã€å‘é€éªŒè¯ç ç­‰ï¼‰ã€‚

#### 1.2 å¸¸è§ç±»å‹

| ç±»å‹             | ç¤ºä¾‹                                   | éªŒè¯é€»è¾‘                |
| ---------------- | -------------------------------------- | ----------------------- |
| **æ»‘å—éªŒè¯ç **   | æ‹–åŠ¨æ‹¼å›¾æ»‘å—åˆ°ç¼ºå£ä½ç½®                 | åˆ¤æ–­æ»‘åŠ¨è½¨è¿¹ + æœ€ç»ˆä½ç½® |
| **æ—‹è½¬éªŒè¯ç **   | æ—‹è½¬å›¾ç‰‡ä½¿å…¶è§’åº¦æ­£ç¡®                   | åˆ¤æ–­æ—‹è½¬è§’åº¦ä¸è½¨è¿¹      |
| **ç‚¹é€‰éªŒè¯ç **   | æŒ‰é¡ºåºç‚¹å‡»ç‰¹å®šåŒºåŸŸï¼ˆå¦‚â€œçŒ«ã€ç‹—ã€é¸Ÿâ€ï¼‰   | åˆ¤æ–­ç‚¹å‡»ä½ç½®ä¸é¡ºåº      |
| **è½¨è¿¹éªŒè¯ç **   | æ¨¡æ‹Ÿæ‹–æ‹½ã€æ¶‚æŠ¹ç­‰è‡ªç„¶åŠ¨ä½œ               | è½¨è¿¹ç‰¹å¾åŒ¹é…            |
| **æ™ºèƒ½è¡Œä¸ºåˆ†æ** | åˆ†æé¼ æ ‡è½¨è¿¹ã€ç‚¹å‡»èŠ‚å¥ã€é¡µé¢ç„¦ç‚¹å˜åŒ–ç­‰ | ä½¿ç”¨æœºå™¨å­¦ä¹ æ¨¡å‹åˆ¤å®š    |

#### 1.3 åº”ç”¨åœºæ™¯

è¡Œä¸ºéªŒè¯ç é€šå¸¸ç”¨äºä»¥ä¸‹å®‰å…¨æ•æ„Ÿæ“ä½œå‰ï¼š

- ç™»å½•ã€æ³¨å†Œã€å¯†ç æ‰¾å›
- å‘é€çŸ­ä¿¡æˆ–é‚®ç®±éªŒè¯ç 
- æäº¤è¡¨å•ã€å‘è¡¨è¯„è®º
- é˜²æ­¢çˆ¬è™«ã€æ¶æ„æ¥å£è¯·æ±‚

#### 1.4 ä¼˜ç‚¹

âœ… ç”¨æˆ·ä½“éªŒå¥½ï¼ˆäº¤äº’ç®€å•ã€æ— é¡»è¾“å…¥æ–‡å­—ï¼‰
âœ… å®‰å…¨æ€§é«˜ï¼ˆæœºå™¨äººéš¾ä»¥æ¨¡æ‹ŸçœŸå®è¡Œä¸ºï¼‰
âœ… å¯ç»“åˆé£æ§ç³»ç»Ÿä½¿ç”¨ï¼ˆè¡Œä¸ºæ•°æ®å¯äºŒæ¬¡åˆ†æï¼‰
âœ… æ”¯æŒæ— éšœç¢è®¾è®¡ï¼Œéƒ¨åˆ†ç‰ˆæœ¬å¯é€‚é…ç§»åŠ¨ç«¯è§¦æ‘¸æ“ä½œ

#### 1.5 å¸¸ç”¨æ–¹æ¡ˆ

| åç§°                             | ç®€ä»‹                                               | è¯­è¨€/æ¡†æ¶                |
| -------------------------------- | -------------------------------------------------- | ------------------------ |
| **Tianai-Captchaï¼ˆå¤©çˆ±éªŒè¯ç ï¼‰** | å¼€æº Java è¡Œä¸ºéªŒè¯ç ç»„ä»¶ï¼Œæ”¯æŒæ»‘å—ã€æ—‹è½¬ç­‰å¤šç§æ¨¡å¼ | Java + Spring Boot       |
| **CAPTCHAjs / Cap**              | å‰ç«¯è¡Œä¸ºéªŒè¯æ–¹æ¡ˆï¼Œæä¾›å¯è§†åŒ–éªŒè¯å¼¹çª—               | JavaScript / React / Vue |
| **GeeTestï¼ˆæéªŒï¼‰**              | å•†ä¸šçº§è¡Œä¸ºéªŒè¯ç æœåŠ¡ï¼Œå¹¿æ³›ç”¨äºä¼ä¸šå®‰å…¨éªŒè¯         | å¤šè¯­è¨€SDK                |
| **Altcha**                       | å…è´¹ä¸”éšç§å‹å¥½çš„å‰ç«¯è¡Œä¸ºéªŒè¯ç»„ä»¶                   | HTML + JSï¼Œæ”¯æŒé™æ€éƒ¨ç½²  |

å¤©çˆ±éªŒè¯ç ï¼šhttps://github.com/dromara/tianai-captcha

#### 1.6 å®ç°æ¡ˆä¾‹

application.ymlé…ç½®

```yml
# è¡Œä¸ºéªŒè¯ç é…ç½®ï¼Œ è¯¦ç»†è¯·çœ‹ cloud.tianai.captcha.autoconfiguration.ImageCaptchaProperties ç±»
captcha:
  # å¦‚æœé¡¹ç›®ä¸­ä½¿ç”¨åˆ°äº†redisï¼Œæ»‘å—éªŒè¯ç ä¼šè‡ªåŠ¨æŠŠéªŒè¯ç æ•°æ®å­˜åˆ°redisä¸­ï¼Œ è¿™é‡Œé…ç½®redisçš„keyçš„å‰ç¼€,é»˜è®¤æ˜¯captcha:slider
  prefix: captcha
  # éªŒè¯ç è¿‡æœŸæ—¶é—´ï¼Œé»˜è®¤æ˜¯2åˆ†é’Ÿ,å•ä½æ¯«ç§’ï¼Œ å¯ä»¥æ ¹æ®è‡ªèº«ä¸šåŠ¡è¿›è¡Œè°ƒæ•´
  expire:
    # é»˜è®¤ç¼“å­˜æ—¶é—´ 2åˆ†é’Ÿ
    default: 10000
    # é’ˆå¯¹ ç‚¹é€‰éªŒè¯ç  è¿‡æœŸæ—¶é—´è®¾ç½®ä¸º 2åˆ†é’Ÿï¼Œ å› ä¸ºç‚¹é€‰éªŒè¯ç éªŒè¯æ¯”è¾ƒæ…¢ï¼ŒæŠŠè¿‡æœŸæ—¶é—´è°ƒæ•´å¤§ä¸€äº›
    WORD_IMAGE_CLICK: 20000
  # ä½¿ç”¨åŠ è½½ç³»ç»Ÿè‡ªå¸¦çš„èµ„æºï¼Œ é»˜è®¤æ˜¯ false(è¿™é‡Œç³»ç»Ÿçš„é»˜è®¤èµ„æºåŒ…å« æ»‘åŠ¨éªŒè¯ç æ¨¡æ¿/æ—‹è½¬éªŒè¯ç æ¨¡æ¿,å¦‚æœæƒ³ä½¿ç”¨ç³»ç»Ÿçš„æ¨¡æ¿ï¼Œè¿™é‡Œè®¾ç½®ä¸ºtrue)
  init-default-resource: true
  # ç¼“å­˜æ§åˆ¶ï¼Œ é»˜è®¤ä¸ºfalseä¸å¼€å¯
  local-cache-enabled: false
  # ç¼“å­˜å¼€å¯åï¼ŒéªŒè¯ç ä¼šæå‰ç¼“å­˜ä¸€äº›ç”Ÿæˆå¥½çš„éªŒè¯æ•°æ®ï¼Œ é»˜è®¤æ˜¯20
  local-cache-size: 20
  # ç¼“å­˜å¼€å¯åï¼Œç¼“å­˜æ‹‰å–å¤±è´¥åç­‰å¾…æ—¶é—´ é»˜è®¤æ˜¯ 5ç§’é’Ÿ
  local-cache-wait-time: 5000
  # ç¼“å­˜å¼€å¯åï¼Œç¼“å­˜æ£€æŸ¥é—´éš” é»˜è®¤æ˜¯2ç§’é’Ÿ
  local-cache-period: 2000
  # é…ç½®å­—ä½“åŒ…ï¼Œä¾›æ–‡å­—ç‚¹é€‰éªŒè¯ç ä½¿ç”¨,å¯ä»¥é…ç½®å¤šä¸ªï¼Œä¸é…ç½®ä½¿ç”¨é»˜è®¤çš„å­—ä½“
  font-path:
    - classpath:font/SimHei.ttf
  secondary:
    # äºŒæ¬¡éªŒè¯ï¼Œ é»˜è®¤false ä¸å¼€å¯
    enabled: false
    # äºŒæ¬¡éªŒè¯è¿‡æœŸæ—¶é—´ï¼Œ é»˜è®¤ 2åˆ†é’Ÿ
    expire: 120000
    # äºŒæ¬¡éªŒè¯ç¼“å­˜keyå‰ç¼€ï¼Œé»˜è®¤æ˜¯ captcha:secondary
    keyPrefix: "captcha:secondary"
```

åç«¯

```java
@RestController
@RequestMapping("/captcha")
@RequiredArgsConstructor
public class CaptchaController {
    @Autowired
    private ImageCaptchaApplication application;
    private final StringRedisTemplate stringRedisTemplate;

    @PostMapping("/gen")
    public ApiResponse<ImageCaptchaVO> genCaptcha() {
        // ç”ŸæˆéªŒè¯ç (è¯¥æ•°æ®è¿”å›ç»™å‰ç«¯ç”¨äºå±•ç¤ºéªŒè¯ç æ•°æ®)
        // å‚æ•°1ä¸ºå…·ä½“çš„éªŒè¯ç ç±»å‹ï¼Œ é»˜è®¤æ”¯æŒ SLIDERã€ROTATEã€WORD_IMAGE_CLICKã€CONCAT ç­‰éªŒè¯ç ç±»å‹ï¼Œè¯¦è§ï¼š `CaptchaTypeConstant`ç±»
        return  application.generateCaptcha(CaptchaTypeConstant.SLIDER);
    }

    @PostMapping("/check")
    public ApiResponse<?> checkCaptcha(@RequestBody Data data) {
        ApiResponse<?> response = application.matching(data.getId(), data.getData());
        if (response.isSuccess()) {
            // éªŒè¯ç éªŒè¯æˆåŠŸï¼Œæ­¤å¤„åº”è¯¥è¿›è¡Œè‡ªå®šä¹‰ä¸šåŠ¡å¤„ç†ï¼Œ æˆ–è€…è¿”å›éªŒè¯tokenè¿›è¡ŒäºŒæ¬¡éªŒè¯ç­‰ã€‚
            stringRedisTemplate.opsForValue().set(RedisConstant.CAPTCHA_VALID_TOKEN_PREFIX + data.getId(), "true", 5 * 60, java.util.concurrent.TimeUnit.SECONDS);
            return ApiResponse.ofSuccess(Collections.singletonMap("validToken", data.getId()));
        }
        return response;
    }

    @lombok.Data
    public static class Data {
        // éªŒè¯ç id
        private String  id;
        // éªŒè¯ç æ•°æ®
        private ImageCaptchaTrack data;
        // å¯ä»¥åŠ ç”¨æˆ·è‡ªå®šä¹‰ä¸šåŠ¡å‚æ•°...
    }
}
```

å‰ç«¯ `CaptchaDialog.jsx`

```jsx
"use client";

import { useEffect, useState } from "react";

/**
 * é€šç”¨è¡Œä¸ºéªŒè¯ç ç»„ä»¶ï¼ˆåŸºäº Tianai Captchaï¼‰
 * props:
 * - onSuccess: éªŒè¯æˆåŠŸåçš„å›è°ƒ (token æˆ–éªŒè¯ç»“æœ)
 * - onFail: éªŒè¯å¤±è´¥å›è°ƒï¼ˆå¯é€‰ï¼‰
 * - visible: æ§åˆ¶æ˜¯å¦æ˜¾ç¤ºéªŒè¯çª—å£
 * - onClose: éªŒè¯çª—å£å…³é—­äº‹ä»¶
 */
export const CaptchaDialog = ({ visible, onSuccess, onFail, onClose }) => {
  const [tacLoaded, setTacLoaded] = useState(false);

  /** åŠ¨æ€åŠ è½½ Tianai Captcha SDK */
  const loadTACScript = () => {
    return new Promise((resolve, reject) => {
      if (window.initTAC) {
        setTacLoaded(true);
        resolve();
        return;
      }

      const script = document.createElement("script");
      script.src = "/tac/js/tac.min.js"; // æ”¾åœ¨ public/tac ä¸‹
      script.onload = () => {
        setTacLoaded(true);
        resolve();
      };
      script.onerror = reject;
      document.body.appendChild(script);

      // åŠ è½½æ ·å¼
      const link = document.createElement("link");
      link.rel = "stylesheet";
      link.href = "/tac/css/tac.css";
      document.head.appendChild(link);
    });
  };

  /** åˆå§‹åŒ–éªŒè¯ç  */
  const initCaptcha = async () => {
    if (!visible) return;
    if (!tacLoaded) await loadTACScript();

    const config = {
      requestCaptchaDataUrl: "/api/captcha/gen", // åç«¯ç”Ÿæˆæ¥å£
      validCaptchaUrl: "/api/captcha/check",     // æ ¡éªŒæ¥å£
      bindEl: "#captcha-box",
      validSuccess: (res, c, tac) => {
        console.log("âœ… éªŒè¯æˆåŠŸ:", res);
        tac.destroyWindow();
        onSuccess?.(res);
      },
      validFail: (res, c, tac) => {
        console.warn("âŒ éªŒè¯å¤±è´¥:", res);
        tac.reloadCaptcha();
        onFail?.(res);
      },
      btnRefreshFun: (el, tac) => tac.reloadCaptcha(),
      btnCloseFun: (el, tac) => {
        tac.destroyWindow();
        onClose?.();
      },
    };

    const style = {
      logoUrl: null, // ä¸æ˜¾ç¤º logo
    };

    window
      .initTAC("/tac", config, style)
      .then((tac) => tac.init())
      .catch((e) => console.error("åˆå§‹åŒ–TACå¤±è´¥:", e));
  };

  useEffect(() => {
    initCaptcha();
  }, [visible]);

  return visible ? <div
      style={{
        position: "fixed",
        top: 0,
        left: 0,
        width: "100vw",
        height: "100vh",
        backgroundColor: "rgba(0, 0, 0, 0.4)",
        display: "flex",
        alignItems: "center",
        justifyContent: "center",
        zIndex: 9999,
      }}
    >
      <div
        id="captcha-box"
        style={{
          background: "#fff",
          borderRadius: "8px",
          boxShadow: "0 0 12px rgba(0,0,0,0.3)",
          overflow: "hidden",
        }}
      ></div>
    </div> : null;
};
```

### 2. é‚®ç®±éªŒè¯ç 

ä»¥126é‚®ç®±ä¸ºä¾‹ã€‚

#### 2.1 126é‚®ç®±

è¿›å…¥è®¾ç½®é¡µé¢ï¼š

![image-20251105183606178](.\assets\image-20251105183606178.png)

å¼€å¯SMTPæœåŠ¡ï¼š

![image-20251105183658637](.\assets\image-20251105183658637.png)

è®°ä½ **æˆæƒç **ã€‚

#### 2.2 åç«¯å®ç°

å¼•å…¥ä¾èµ–ï¼š

```java
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-mail</artifactId>
</dependency>
```

application.yml

```yml
spring:
  mail:
    host: smtp.126.com
    username: xxxxx@126.com
    password: xxxxxxxxxxxxxxxx
    default-encoding: UTF-8
```

EmailDTO

```java
@Data
@AllArgsConstructor
@NoArgsConstructor
public class EmailDTO {
    // æ”¶ä»¶é‚®ç®±
    private String email;
    // æ ‡é¢˜
    private String title;
    // å†…å®¹
    private String content;
}
```

EmailService

```java
public interface EmailService {
    void sendMsg(EmailDTO emailDTO);
}
```

EmailServiceImpl

```java
@Service
public class EmailServiceImpl implements EmailService {
    //é‚®ä»¶å‘é€äºº application.ymlä¸­çš„username
    @Value("${spring.mail.username}")
    private String from;

    @Autowired(required = false)
    private JavaMailSender mailSender;

    @Override
    public void sendMsg(EmailDTO emailDTO) {
        //åˆ›å»ºä¸€ä¸ªå¯¹è±¡
        SimpleMailMessage mailMessage = new SimpleMailMessage();

        //å¼€å§‹å‘é€
        mailMessage.setFrom(from);
        mailMessage.setTo(emailDTO.getEmail());
        mailMessage.setSubject(emailDTO.getTitle());
        mailMessage.setText(emailDTO.getContent());

        //çœŸæ­£çš„å‘é€é‚®ä»¶æ“ä½œï¼Œä»fromåˆ°to
        mailSender.send(mailMessage);
    }
}
```

### 3. çŸ­ä¿¡éªŒè¯ç 

#### 3.1 çŸ­ä¿¡å®å¹³å°

å®˜ç½‘ï¼šhttps://console.smsbao.com/#/index

æ–‡æ¡£ï¼šhttps://www.smsbao.com/openapi

#### 3.2 åç«¯å®ç°

application.yml

```yml
sms:
  username: dawnstar
  password: Password0k$
  content: ã€xxxxã€‘æ‚¨çš„éªŒè¯ç æ˜¯{code}ã€‚å¦‚éæœ¬äººæ“ä½œï¼Œè¯·å¿½ç•¥æœ¬çŸ­ä¿¡
```

SmsService

```java
public interface SmsService {
    void sendMsg(String phone,String code, String type);
}
```

SmsServiceImpl

```java
/**
 * çŸ­ä¿¡æœåŠ¡å®ç°ç±»
 */
@Service
@RequiredArgsConstructor
@Slf4j
public class SmsServiceImpl implements SmsService {

    private final StringRedisTemplate stringRedisTemplate;
    private final RedisTemplate<String, String> redisTemplate;
    private final HttpServletRequest request;

    private static final String RATE_LIMITER_KEY = "rate_limiter:";
    private static final int MAX_REQUESTS = 5; // æœ€å¤§è¯·æ±‚æ¬¡æ•°
    private static final int TIME_WINDOW = 60; // æ—¶é—´çª—å£ï¼ˆç§’ï¼‰

    @Value("${sms.username}")
    private String smsUsername;
    @Value("${sms.password}")
    private String smsPassword;
    @Value("${sms.content}")
    private String smsContent;

    @Override
    public void sendMsg(String phone,String code, String type) {
        if (phone == null){
            ExceptionTool.throwException("æ‰‹æœºå·ä¸èƒ½ä¸ºç©º");
        }
        // è·å–å®¢æˆ·ç«¯ IP
        String clientIp = IpUtil.getClientIp(request);
        // æ£€æŸ¥æ˜¯å¦è¶…è¿‡è¯·æ±‚é™åˆ¶
        if (!allowRequest(clientIp)) {
            ExceptionTool.throwException("è¯·æ±‚é¢‘ç‡è¿‡é«˜ï¼Œè¯·ç¨åå†è¯•");
        }
        String key = ""; // Redis keyï¼Œç”¨äºåç»­æ ¡éªŒ
        if (CodeTypeEnum.REGISTER_PHONE_CODE.getType().equals(type)){
            // æ³¨å†Œ
            key = RedisConstant.PHONE_REGISTER_CODE_PREFIX + phone;
        } else if(CodeTypeEnum.LOGIN_PHONE_CODE.getType().equals(type)){
            // ç™»å½•
            key = RedisConstant.PHONE_LOGIN_CODE_PREFIX + phone;
        } else {
            ExceptionTool.throwException("æœªçŸ¥çš„éªŒè¯ç ç±»å‹");
        }
        // å¾€Redisä¸­å­˜å‚¨ä¸€ä¸ªé”®å€¼å¯¹
        ValueOperations<String, String> operations = stringRedisTemplate.opsForValue();
        operations.set(key,  code, RedisConstant.CODE_TIME_SECOND, TimeUnit.SECONDS);
        // æ¨¡æ‹Ÿå‘é€çŸ­ä¿¡
        log.info("å‘é€çŸ­ä¿¡æˆåŠŸ------------");
        sendSmsByBao(code, phone, clientIp);
    }

    private boolean allowRequest(String ip) {
        String key = RATE_LIMITER_KEY + ip;
        Long currentCount = redisTemplate.opsForValue().increment(key);

        if (currentCount == 1) {
            redisTemplate.expire(key, TIME_WINDOW, TimeUnit.SECONDS);
        }

        return currentCount <= MAX_REQUESTS;
    }

    private void sendSmsByBao(String code, String phone, String ip){
        if (!allowRequest(ip)) {
            System.out.println(ip + "è¯·æ±‚é¢‘ç‡è¿‡é«˜ï¼Œè¯·ç¨åå†è¯•");
            throw new RuntimeException("è¯·æ±‚é¢‘ç‡è¿‡é«˜ï¼Œè¯·ç¨åå†è¯•");
        }
        String myUsername = smsUsername; //åœ¨çŸ­ä¿¡å®æ³¨å†Œçš„ç”¨æˆ·å
        String myPassword = smsPassword; //åœ¨çŸ­ä¿¡å®æ³¨å†Œçš„å¯†ç 
        String myContent = smsContent;
        String content = myContent.replace("{code}", code); //è¦å‘é€çš„çŸ­ä¿¡å†…å®¹

        String httpUrl = "http://api.smsbao.com/sms";

        StringBuffer httpArg = new StringBuffer();
        httpArg.append("u=").append(myUsername).append("&");
        httpArg.append("p=").append(md5(myPassword)).append("&");
        httpArg.append("m=").append(phone).append("&");
        httpArg.append("c=").append(encodeUrlString(content, "UTF-8"));

        String result = request(httpUrl, httpArg.toString());
        System.out.println(result);
    }

    public static String request(String httpUrl, String httpArg) {
        BufferedReader reader = null;
        String result = null;
        StringBuilder sbf = new StringBuilder();
        httpUrl = httpUrl + "?" + httpArg;

        try {
            URL url = new URL(httpUrl);
            HttpURLConnection connection = (HttpURLConnection) url.openConnection();
            connection.setRequestMethod("GET");
            connection.connect();
            InputStream is = connection.getInputStream();
            reader = new BufferedReader(new InputStreamReader(is, "UTF-8"));
            String strRead = reader.readLine();
            if (strRead != null) {
                sbf.append(strRead);
                while ((strRead = reader.readLine()) != null) {
                    sbf.append("\n");
                    sbf.append(strRead);
                }
            }
            reader.close();
            result = sbf.toString();
        } catch (Exception e) {
            e.printStackTrace();
        }
        return result;
    }

    public static String md5(String plainText) {
        StringBuilder buf = null;
        try {
            MessageDigest md = MessageDigest.getInstance("MD5");
            md.update(plainText.getBytes());
            byte[] b = md.digest();
            int i;
            buf = new StringBuilder();
            for (byte value : b) {
                i = value;
                if (i < 0)
                    i += 256;
                if (i < 16)
                    buf.append("0");
                buf.append(Integer.toHexString(i));
            }
        } catch (NoSuchAlgorithmException e) {
            e.printStackTrace();
        }
        return buf.toString();
    }

    public static String encodeUrlString(String str, String charset) {
        String strret = null;
        if (str == null)
            return str;
        try {
            strret = java.net.URLEncoder.encode(str, charset);
        } catch (Exception e) {
            e.printStackTrace();
            return null;
        }
        return strret;
    }
}
```

## äºŒã€æ³¨å†Œ

æ³¨å†Œæ–¹å¼æœ‰é‚®ç®±æ³¨å†Œå’Œæ‰‹æœºå·æ³¨å†Œã€‚

![image-20251106215049166](.\assets\image-20251106215049166.png)

![image-20251106215104816](.\assets\image-20251106215104816.png)

### 1. æ³¨å†Œæ­¥éª¤

ç”¨æˆ·é¦–å…ˆè¾“å…¥é‚®ç®±/æ‰‹æœºå·ï¼Œç‚¹å‡»è·å–éªŒè¯ç ï¼Œè¿›è¡Œè¡Œä¸ºæ ¡éªŒï¼Œè¡Œä¸ºæ ¡éªŒé€šè¿‡åä¼šå‘é€éªŒè¯ç ã€‚

ç”¨æˆ·è·å–éªŒè¯ç ä¹‹åï¼Œè¾“å…¥éªŒè¯ç ã€å¯†ç å’Œç¡®è®¤å¯†ç è¿›è¡Œæ³¨å†Œã€‚

### 2. å®ç°

#### 2.1 å‰ç«¯

`Register.tsx`

```tsx
"use client";

import React, { useRef, useState } from "react";
import { Button, Input, Checkbox, Link, Tabs, Tab } from "@heroui/react";
import { Icon } from "@iconify/react";
import { toast } from "react-hot-toast";

import { sendCodeAPI } from "@/apis/user";
import { CaptchaDialog } from "@/components/common/CaptchaDialog";

export const Register = () => {
  const [isVisible, setIsVisible] = React.useState(false);
  const [isConfirmVisible, setIsConfirmVisible] = React.useState(false);

  const [countdown, setCountdown] = React.useState(0); // å€’è®¡æ—¶
  const [registerType, setRegisterType] = useState<"email" | "phone">("email");
  const [emailOrPhone, setEmailOrPhone] = useState<string>("");

  const [captchaVisible, setCaptchaVisible] = useState(false); // æ§åˆ¶è¡Œä¸ºéªŒè¯ç å¼¹çª—
  const timerRef = useRef<NodeJS.Timeout | null>(null);

  /** å¯†ç æ˜¾ç¤ºåˆ‡æ¢ */
  const toggleVisibility = () => setIsVisible(!isVisible);
  const toggleConfirmVisibility = () => setIsConfirmVisible(!isConfirmVisible);

  /** æäº¤æ³¨å†Œé€»è¾‘ */
  const handleSubmit = (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    if (registerType === "email") {
      // ğŸ“¬ é‚®ç®±æ³¨å†Œé€»è¾‘
      console.log("é‚®ç®±æ³¨å†Œ");
    } else {
      // ğŸ“± æ‰‹æœºæ³¨å†Œé€»è¾‘
      console.log("æ‰‹æœºæ³¨å†Œ");
    }
  };
    
   /** ğŸ§  ç‚¹å‡»â€œè·å–éªŒè¯ç â€å‰å…ˆè¿›è¡Œè¡Œä¸ºéªŒè¯ */
  const handleBeforeSendCode = () => {
    if (countdown > 0) return; // é˜²æ­¢é‡å¤ç‚¹å‡»
    if (!emailOrPhone) {
      toast.error("è¯·è¾“å…¥é‚®ç®±æˆ–æ‰‹æœºå·ï¼");
      return;
    }
    setCaptchaVisible(true); // æ˜¾ç¤ºè¡Œä¸ºéªŒè¯å¼¹çª—
  };

  /** âœ… è¡Œä¸ºéªŒè¯ç é€šè¿‡åå†å‘é€éªŒè¯ç  */
  const handleCaptchaSuccess = async (res: any) => {
    console.log("è¡Œä¸ºéªŒè¯é€šè¿‡:", res);
    setCaptchaVisible(false);

    try {
      const type = registerType === "email" ? "emailRegister" : "phoneRegister";

      // ä¼ é€’è¡Œä¸ºéªŒè¯è¿”å›çš„tokenåˆ°åç«¯ï¼ˆå¦‚æœåç«¯éœ€è¦ï¼‰
      const resData = await sendCodeAPI(emailOrPhone, type, res.data.validToken);
      // const resData = await sendCodeAPI(emailOrPhone, type);

      if (resData.code === 0) {
        toast.success(
          registerType === "email"
            ? "ğŸ“¬ éªŒè¯ç å·²å‘é€è‡³é‚®ç®±"
            : "ğŸ“± éªŒè¯ç å·²å‘é€è‡³æ‰‹æœº"
        );
      } else {
        toast.error(resData.message || "å‘é€å¤±è´¥");
        return;
      }

      // å¯åŠ¨å€’è®¡æ—¶
      setCountdown(60);
      timerRef.current = setInterval(() => {
        setCountdown((prev) => {
          if (prev <= 1) {
            if (timerRef.current) clearInterval(timerRef.current);
            return 0;
          }
          return prev - 1;
        });
      }, 1000);
    } catch (error) {
      console.error(error);
      toast.error("å‘é€éªŒè¯ç å¤±è´¥ï¼Œè¯·ç¨åå†è¯•");
    }
  };

  /** âœ¨ æ¸…é™¤å®šæ—¶å™¨ */
  React.useEffect(() => {
    return () => {
      if (timerRef.current) clearInterval(timerRef.current);
    };
  }, []);

  return (
    <div className="flex h-full w-full items-center justify-center">
      <div className="rounded-large flex w-full max-w-sm flex-col gap-2 px-8">
        <p className="pb-2 text-left text-3xl font-semibold">
          æ³¨å†Œ
          <span aria-label="emoji" className="ml-2" role="img">
            ğŸ‘‹
          </span>
        </p>

        {/* æ³¨å†Œæ–¹å¼åˆ‡æ¢ */}
        <Tabs
          fullWidth
          aria-label="æ³¨å†Œæ–¹å¼"
          selectedKey={registerType}
          variant="underlined"
          onSelectionChange={(key) =>
            setRegisterType(key as "email" | "phone")
          }
        >
          <Tab key="email" title="é‚®ç®±æ³¨å†Œ" />
          <Tab key="phone" title="æ‰‹æœºå·æ³¨å†Œ" />
        </Tabs>

        <form className="flex flex-col gap-2" onSubmit={handleSubmit}>
          {/*  é‚®ç®±æ³¨å†Œ */}
          {registerType === "email" && (
            <Input
              isRequired
              label="é‚®ç®±"
              labelPlacement="outside"
              name="email"
              placeholder="è¯·è¾“å…¥é‚®ç®±"
              type="email"
              variant="bordered"
              value={emailOrPhone}
              onChange={(e) => setEmailOrPhone(e.target.value)}
            />
          )}

          {/* æ‰‹æœºæ³¨å†Œ */}
          {registerType === "phone" && (
            <Input
              isRequired
              label="æ‰‹æœºå·"
              labelPlacement="outside"
              name="phone"
              placeholder="è¯·è¾“å…¥æ‰‹æœºå·"
              type="tel"
              variant="bordered"
              value={emailOrPhone}
              onChange={(e) => setEmailOrPhone(e.target.value)}
            />
          )}

          {/* éªŒè¯ç ï¼ˆä¸¤ç§æ–¹å¼å…±ç”¨ï¼‰ */}
          <div className="flex gap-2">
            <Input
              isRequired
              label="éªŒè¯ç "
              labelPlacement="outside"
              name="code"
              placeholder="è¯·è¾“å…¥éªŒè¯ç "
              type="text"
              variant="bordered"
              className="flex-1"
            />
            <Button
              type="button"
              onClick={handleBeforeSendCode}
              className="h-[40px] mt-6"
              disabled={countdown > 0}
              color={countdown > 0 ? "default" : "primary"}
            >
              {countdown > 0 ? `${countdown}s` : "è·å–éªŒè¯ç "}
            </Button>
          </div>

          {/* å¯†ç  */}
          <Input
            isRequired
            endContent={
              <button type="button" onClick={toggleVisibility}>
                {isVisible ? (
                  <Icon
                    className="text-default-400 pointer-events-none text-2xl"
                    icon="solar:eye-closed-linear"
                  />
                ) : (
                  <Icon
                    className="text-default-400 pointer-events-none text-2xl"
                    icon="solar:eye-bold"
                  />
                )}
              </button>
            }
            label="å¯†ç "
            labelPlacement="outside"
            name="password"
            placeholder="è¯·è¾“å…¥å¯†ç "
            type={isVisible ? "text" : "password"}
            variant="bordered"
          />

          {/* ç¡®è®¤å¯†ç  */}
          <Input
            isRequired
            endContent={
              <button type="button" onClick={toggleConfirmVisibility}>
                {isConfirmVisible ? (
                  <Icon
                    className="text-default-400 pointer-events-none text-2xl"
                    icon="solar:eye-closed-linear"
                  />
                ) : (
                  <Icon
                    className="text-default-400 pointer-events-none text-2xl"
                    icon="solar:eye-bold"
                  />
                )}
              </button>
            }
            label="ç¡®è®¤å¯†ç "
            labelPlacement="outside"
            name="confirmPassword"
            placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç "
            type={isConfirmVisible ? "text" : "password"}
            variant="bordered"
          />

          <Checkbox isRequired className="py-4" size="sm">
            æˆ‘åŒæ„&nbsp;
            <Link className="relative z-1" href="#" size="sm">
              ç”¨æˆ·åè®®
            </Link>
            &nbsp;å’Œ&nbsp;
            <Link className="relative z-1" href="#" size="sm">
              éšç§æ”¿ç­–
            </Link>
          </Checkbox>

          <Button color="primary" type="submit">
            æ³¨å†Œ
          </Button>
        </form>
        <p className="text-small text-center">
          <Link href="/login" size="sm">
            å·²æœ‰è´¦å·? å»ç™»å½•
          </Link>
        </p>
      </div>
      {/* âœ¨ è¡Œä¸ºéªŒè¯ç å¼¹çª— */}
      <CaptchaDialog
        visible={captchaVisible}
        onSuccess={handleCaptchaSuccess}
        onClose={() => setCaptchaVisible(false)}
      />
    </div>
  );
}
```

`user.ts`

```ts
import request from "./index";

/** æ¥å£è¿”å›é€šç”¨ç»“æ„ */
export interface Result<T = any> {
  code: number;
  message: string;
  data?: T;
}

/**
 * å‘é€éªŒè¯ç ï¼ˆé‚®ç®±æˆ–æ‰‹æœºï¼‰
 * @param emailOrPhone é‚®ç®±æˆ–æ‰‹æœºå·
 * @param type ç±»å‹ï¼šemailLogin, phoneLogin, emailRegister, phoneRegister
 */
export const sendCodeAPI = (
  emailOrPhone: string,
  type: string,
  token: string
): Promise<Result> => {
  return request.post("/sendCode", null, {
    params: { emailOrPhone, type, token },
  });
};
```

#### 2.2 åç«¯

```java
/**
 * æ³¨å†Œ
 * - æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
 * - æ£€æŸ¥éªŒè¯ç æ˜¯å¦æ­£ç¡®
 * - æ£€æŸ¥ä¸¤æ¬¡å¯†ç æ˜¯å¦ä¸€è‡´
 * - ä¿å­˜ç”¨æˆ·ä¿¡æ¯
 * @param registerDTO
 */
@Override
public void register(RegisterDTO registerDTO) {
    // æŸ¥è¯¢ç”¨æˆ·æ˜¯å¦å­˜åœ¨
    SysUser userByUsernameOrEmail = userMapper.getUserByUsernameOrEmailOrPhone(registerDTO.getEmail());
    if (userByUsernameOrEmail != null){
        ExceptionTool.throwException("ç”¨æˆ·å·²å­˜åœ¨ï¼");
    }
    // æ£€æŸ¥éªŒè¯ç æ˜¯å¦æ­£ç¡®
    ValueOperations<String, String> operations = stringRedisTemplate.opsForValue();
    String key = "";
    if (Objects.equals(registerDTO.getType(), CodeTypeEnum.REGISTER_EMAIL_CODE.getType())){
        key = EMAIL_REGISTER_CODE_PREFIX + registerDTO.getEmail();
    } else if (Objects.equals(registerDTO.getType(), CodeTypeEnum.REGISTER_PHONE_CODE.getType())){
        key = PHONE_REGISTER_CODE_PREFIX + registerDTO.getPhone();
    }
    String redisCode = operations.get(key);
    if (!registerDTO.getCode().equals(redisCode)){
        ExceptionTool.throwException("éªŒè¯ç é”™è¯¯ï¼");
    }
    // æ£€æŸ¥ä¸¤æ¬¡å¯†ç æ˜¯å¦ä¸€è‡´
    if (!registerDTO.getPassword().equals(registerDTO.getRePassword())){
        ExceptionTool.throwException("ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´ï¼");
    }
    SysUser user = new SysUser();
    user.setUsername(registerDTO.getEmail());
    user.setPassword(passwordEncoder.encode(registerDTO.getPassword()));
    user.setCreateTime(LocalDateTime.now());
    user.setUpdateTime(LocalDateTime.now());
    // è·å–ä¸¤ç§è§’è‰²
    SysRole roleSuperAdmin = sysRoleService.getRoleByRoleCode("ROLE_SUPER_ADMIN");
    SysRole roleUser = sysRoleService.getRoleByRoleCode("ROLE_USER");
    userMapper.add(user);
    // superAdminListè®¾ç½®ä¸ºSuper Adminï¼Œå…¶ä»–ç”¨æˆ·è®¾ç½®ä¸ºæ™®é€šç”¨æˆ·User
    List<String> superAdminList = getSuperAdminList();
    if (superAdminList.contains(registerDTO.getEmail()) ||
        superAdminList.contains(registerDTO.getPhone())
    ) {
        sysUserRoleService.add(user.getId(), roleSuperAdmin.getId());
        return;
    }
    sysUserRoleService.add(user.getId(), roleUser.getId());
}
```





